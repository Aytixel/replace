<!DOCTYPE html>
<html lang="en">
    <head>
        <meta http-equiv="content-type" content="text/html; charset=UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="author" content="Aytixel">
        <meta name="description" content="The concept, just the same as r/place">
        <title>re/place</title>
        <style>
            @import url('https://fonts.googleapis.com/css2?family=Roboto&display=swap');

            :root {
                --color1: #fff;
                --color2: #1c1b1a;
                --color3: #9c9894;
            }

            * {
                position: relative;
                z-index: 0;

                margin: 0;
                padding: 0;

                font-family: 'Roboto', sans-serif;
            }

            html {
                height: 100%;
            }

            body {
                height: 100%;

                background-color: var(--color2);
            
                overflow: hidden;
            }
            
            /*

                Position

            */
            #position {
                position: fixed;
                top: 2vh;
                left: 50%;

                padding: 0 1.5vh;

                height: 2.5vh;

                background-color: var(--color1);

                border-radius: 1.25vh;

                line-height: 2.5vh;

                font-size: 1.5vh;

                color: var(--color2);

                box-shadow: 0.1vh 0.1vh 0.4vh -0.2vh var(--color2);

                transform: translateX(-50%);
            }
            
            /*

                Drawing

            */
            #drawing {
                position: absolute;
                top: 50%;
                left: 50%;

                height: 80vh;
                width: 80vh;

                transform: translate(-50%, -50%);
            }

            #drawing canvas {
                position: absolute;

                height: 80vh;
                width: 80vh;

                image-rendering: pixelated;

                transform-origin: top left;
            }

            #drawing #image {
                background-image: url("/current.png");
                background-size: contain;
            }
            
            /*

                Zoom

            */
            #zoom {
                position: fixed;
                right: 2vh;
                bottom: 2vh;

                height: 3vh;
                width: 7vh;

                background-color: var(--color1);

                border-radius: 1.5vh;

                box-shadow: 0.1vh 0.1vh 0.4vh -0.2vh var(--color2);
            }

            #zoom svg {
                margin: 0.25vh;

                height: 2.5vh;
                width: 2.5vh;
            }

            #zoom-level {
                position: absolute;
                top: 0;
                right: 1vh;

                line-height: 3vh;

                font-size: 1.75vh;

                color: var(--color2);
            }
        </style>
    </head>

    <body>
        <div id="drawing">
            <canvas id="image" width="2000" height="2000">Canvas disabled</canvas>
            <canvas id="cursor" width="12000" height="12000">Canvas disabled</canvas>
        </div>
        
        <div id="position">(1000, 1000)</div>

        <div id="zoom">
            <svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width="30" height="30" viewBox="0 0 30 30" style=" fill:#1c1b1a;"><path d="M 13 3 C 7.4889971 3 3 7.4889971 3 13 C 3 18.511003 7.4889971 23 13 23 C 15.396508 23 17.597385 22.148986 19.322266 20.736328 L 25.292969 26.707031 A 1.0001 1.0001 0 1 0 26.707031 25.292969 L 20.736328 19.322266 C 22.148986 17.597385 23 15.396508 23 13 C 23 7.4889971 18.511003 3 13 3 z M 13 5 C 17.430123 5 21 8.5698774 21 13 C 21 17.430123 17.430123 21 13 21 C 8.5698774 21 5 17.430123 5 13 C 5 8.5698774 8.5698774 5 13 5 z"></path></svg>
            <div id="zoom-level">1x</div>
        </div>

        <script type="application/javascript">
            const drawing_element = document.getElementById("drawing")
            const image_canvas_element = document.getElementsByTagName("canvas")[0]
            const cursor_canvas_element = document.getElementsByTagName("canvas")[1]
            const position_element = document.getElementById("position")
            const zoom_level_element = document.getElementById("zoom-level")
            const image_canvas_context = image_canvas_element.getContext('2d')
            const cursor_canvas_context = cursor_canvas_element.getContext('2d')
            let zoom_level = 1;
            const zoom_levels = [1, 2.5, 5, 7.5, 10, 15, 20, 30, 40, 60]
            const canvas_half_heigth = image_canvas_element.clientHeight / 2
            const canvas_offset = { x: canvas_half_heigth, y: canvas_half_heigth }
            const last_position = { x: 1000, y: 1000 }
            const last_screen_position = { x: 0, y: 0 }
            
            image_canvas_context.imageSmoothingEnabled = false

            const clamp = (min, x, max) => Math.max(Math.min(x, max), min)
            const change_pixel = (x, y, color) => {
                image_canvas_context.fillStyle = color
                image_canvas_context.fillRect(x, y, 1, 1)
            }
            const change_cursor = (x, y) => {
                cursor_canvas_context.clearRect(0, 0, 12000, 12000)
                cursor_canvas_context.fillStyle = "#9c9894"
                cursor_canvas_context.fillRect(x * 6 - 2, y * 6 - 2, 10, 10)
                cursor_canvas_context.fillStyle = "#5c5956"
                cursor_canvas_context.fillRect(x * 6 - 1, y * 6 - 1, 8, 8)
                cursor_canvas_context.clearRect(x * 6, y * 6, 6, 6)
                cursor_canvas_context.clearRect(x * 6 - 2, y * 6 + 2, 10, 2)
                cursor_canvas_context.clearRect(x * 6 + 2, y * 6 - 2, 2, 10)
            }
            const update_position = () => {
                const canvas_height = image_canvas_element.clientHeight * zoom_levels[zoom_level - 1]

                canvas_offset.x = clamp(0, (1999 - last_position.x) / 2000 * canvas_height, canvas_height * 0.9995)
                canvas_offset.y = clamp(0, (1999 - last_position.y) / 2000 * canvas_height, canvas_height * 0.9995)
                
                drawing_element.style.transform = `translate(${canvas_offset.x - canvas_height}px, ${canvas_offset.y - canvas_height}px)`
                
                change_cursor(last_position.x, last_position.y)
            }

            // zoom
            window.addEventListener("wheel", e => {
                zoom_level -= Math.sign(e.deltaY)
                zoom_level = clamp(1, zoom_level, 10)
                
                zoom_level_element.textContent = zoom_level + "x"
                image_canvas_element.style.transform = `scale(${zoom_levels[zoom_level - 1]})`
                cursor_canvas_element.style.transform = `scale(${zoom_levels[zoom_level - 1]})`

                update_position()
            })

            // change position
            const start = e => {
                e.preventDefault()

                if (e.changedTouches) e = e.changedTouches[0]

                last_screen_position.x = e.screenX
                last_screen_position.y = e.screenY

                window.addEventListener('mousemove', move)
                window.addEventListener('touchmove', move, { passive: false })
                window.addEventListener('mouseup', end)
                window.addEventListener('mouseleave', end)
                window.addEventListener('touchend', end)
                window.addEventListener('touchcancel', end)
                window.addEventListener('touchleave', end)
            }
            const move = e => {
                e.preventDefault()

                if (e.changedTouches) e = e.changedTouches[0]
                
                canvas_offset.x += (e.screenX - last_screen_position.x)
                canvas_offset.y += (e.screenY - last_screen_position.y)

                last_screen_position.x = e.screenX
                last_screen_position.y = e.screenY
                
                requestAnimationFrame(() => {
                    const canvas_height = image_canvas_element.clientHeight * zoom_levels[zoom_level - 1]

                    canvas_offset.x = clamp(0, canvas_offset.x, canvas_height * 0.9995)
                    canvas_offset.y = clamp(0, canvas_offset.y, canvas_height * 0.9995)

                    last_position.x = Math.round(1999 - (canvas_offset.x / canvas_height * 2000))
                    last_position.y = Math.round(1999 - (canvas_offset.y / canvas_height * 2000))

                    position_element.textContent = `(${last_position.x}, ${last_position.y})`

                    drawing_element.style.transform = `translate(${canvas_offset.x - canvas_height}px, ${canvas_offset.y - canvas_height}px)`

                    change_cursor(last_position.x, last_position.y)
                })
            }
            const end = e => {
                e.preventDefault()

                window.removeEventListener('mousemove', move)
                window.removeEventListener('touchmove', move)
                window.removeEventListener('mouseup', end)
                window.removeEventListener('mouseleave', end)
                window.removeEventListener('touchend', end)
                window.removeEventListener('touchcancel', end)
                window.removeEventListener('touchleave', end)
            }

            window.addEventListener("resize", update_position)
            window.addEventListener("mousedown", start)
            window.addEventListener("touchstart", start, { passive: true })

            change_cursor(1000, 1000)
            
            const ws = new WebSocket("ws://replace.tk")
            let last_update = null

            ws.addEventListener("open", () => {
                ws.addEventListener("message", e => {
                    if (typeof e.data === "string") {
                        const split_data = e.data.split(":")
                        const command = split_data.shift()

                        switch (command) {
                            case "register":
                                localStorage.setItem("uuid", split_data.shift())

                                last_update = new Date(split_data.join(":"))

                                console.log(localStorage.getItem("uuid"), last_update)
                                break
                        }
                    }
                })

                ws.send("register:" + (localStorage.getItem("uuid") || ""))
            })
        </script>
    </body>
</html>