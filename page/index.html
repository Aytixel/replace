<!DOCTYPE html>
<html lang="en">
    <head>
        <meta http-equiv="content-type" content="text/html; charset=UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="author" content="Aytixel">
        <meta name="description" content="The concept, just the same as r/place">
        <title>re/place</title>
        <style>
            @import url('https://fonts.googleapis.com/css2?family=Roboto&display=swap');

            :root {
                --color1: #fff;
                --color2: #1c1b1a;
                --color3: #c7c1bb;
            }

            * {
                position: relative;
                z-index: 0;

                margin: 0;
                padding: 0;

                font-family: 'Roboto', sans-serif;
            }

            html {
                height: 100%;
            }

            body {
                height: 100%;

                background-color: var(--color2);
            
                overflow: hidden;
            }
            
            /*

                Position

            */
            #position {
                position: fixed;
                top: 2vh;
                left: 50%;

                padding: 0 3vh;

                height: 3vh;

                background-color: var(--color1);

                border-radius: 1.5vh;

                line-height: 3vh;

                font-size: 1.75vh;

                color: var(--color2);

                box-shadow: 0.1vh 0.1vh 0.4vh -0.2vh var(--color2);

                transform: translateX(-50%);
            }
            
            /*

                Drawing

            */
            #drawing {
                position: absolute;
                top: 50%;
                left: 50%;

                height: 80vh;
                width: 80vh;

                transform: translate(-50%, -50%);
            }

            #drawing canvas {
                position: absolute;

                height: 80vh;
                width: 80vh;

                image-rendering: pixelated;

                transform-origin: top left;
            }

            #drawing #image {
                background-image: url("/current.png");
                background-size: contain;
            }
            
            /*

                Timer & Zoom

            */
            #timer, #zoom {
                position: fixed;
                left: 50%;
                bottom: 2vh;

                height: 3vh;
                width: 11vh;

                padding: 0 3vh;

                background-color: var(--color1);

                border-radius: 1.5vh;

                box-shadow: 0.1vh 0.1vh 0.4vh -0.2vh var(--color2);

                transform: translateX(-50%);
            }

            #zoom {
                position: fixed;
                left: auto;
                right: 2vh;

                width: 7vh;

                padding: 0;
            }

            #timer svg, #zoom svg {
                margin: 0.25vh;

                height: 2.5vh;
                width: 2.5vh;
            }

            #time, #zoom-level {
                float: right;

                line-height: 3vh;

                font-size: 1.75vh;

                color: var(--color2);
            }

            #zoom-level {
                right: 1vh;
            }

            #place-mode {
                display: none;

                line-height: 3vh;

                font-size: 1.75vh;
            }

            #timer.place-mode {
                width: auto;
            }

            #timer.place-mode :not(#place-mode) {
                display: none;
            }

            #timer.place-mode #place-mode {
                display: block;
            }
            
            /*

                Place Bar

            */
            #place-bar {
                position: fixed;
                bottom: 0;
                
                width: 100vw;

                padding: 1vh 0;

                background-color: var(--color1);

                box-shadow: 0.1vh 0.1vh 0.4vh -0.2vh var(--color2);
            }

            #colors {
                display: flex;
                justify-content: center;
                flex-wrap: wrap;

                margin-top: 1vh;

                left: 50%;

                width: 98vw;

                transform: translateX(-50%);
            }

            #colors .color {
                margin: 0.15vh;

                height: 3vh;
                width: 5vh;

                border-radius: 0.3vh;

                border: solid 0.15vh var(--color3);
                
                transition: 0.2s border-color ease-in-out, 0.2s box-shadow ease-in-out;
            }

            #colors .color.focus, #colors .color:hover {
                border-color: var(--color1);

                box-shadow: 0 0 0 0.15vh var(--color2);
            }

            #burgandy {background-color: #6d001a;}
            #dark-red {background-color: #be0039;}
            #red {background-color: #ff4500;}
            #orange {background-color: #ffa800;}
            #yellow {background-color: #ffd635;}
            #pale-yellow {background-color: #fff8b8;}
            #dark-green {background-color: #00a368;}
            #green {background-color: #00cc78;}
            #light-green {background-color: #7eed56;}
            #dark-teal {background-color: #00756f;}
            #teal {background-color: #009eaa;}
            #light-teal {background-color: #00ccc0;}
            #dark-blue {background-color: #2450a4;}
            #blue {background-color: #3690ea;}
            #light-blue {background-color: #51e9f4;}
            #indigo {background-color: #493ac1;}
            #periwinkle {background-color: #6a5cff;}
            #lavender {background-color: #94b3ff;}
            #dark-purple {background-color: #811e9f;}
            #purple {background-color: #b44ac0;}
            #pale-purple {background-color: #e4abff;}
            #magenta {background-color: #de107f;}
            #pink {background-color: #ff3881;}
            #light-pink {background-color: #ff99aa;}
            #dark-brown {background-color: #6d482f;}
            #brown {background-color: #9c6926;}
            #beige {background-color: #ffb470;}
            #black {background-color: #000000;}
            #dark-gray {background-color: #515252;}
            #gray {background-color: #898d90;}
            #light-gray {background-color: #d4d7d9;}
            #white {background-color: #ffffff;}

            #place-button-container {
                display: flex;
                justify-content: space-evenly;
                flex-wrap: wrap;

                margin-top: 2vh;

                left: 50%;

                width: 80vw;
                min-width: 25.2vh;

                transform: translateX(-50%);
            }

            #cancel-place, #valid-place {
                display: inline-block;

                margin: 0.5vh;

                height: 3vh;
                width: 25vh;

                border: solid 0.1vh var(--color3);

                border-radius: 1.5vh;

                flex-shrink: 0;

                transition: 0.2s border-color ease-in-out;
            }

            #cancel-place:hover, #valid-place:hover {
                border: solid 0.1vh var(--color2);
            }

            #cancel-place::before, #valid-place::before, #cancel-place::after, #valid-place::after {
                display: block;

                position: absolute;
                top: 50%;
                left: 50%;

                height: 0.2vh;
                width: 2vh;

                content: "";

                background-color: var(--color2);
            }

            #cancel-place::before {
                transform: translate(-50%, -50%) rotate(45deg);
            }
            
            #cancel-place::after {
                transform: translate(-50%, -50%) rotate(-45deg);
            }

            #valid-place::before {
                top: 50%;

                width: 1vh;

                transform: translate(-85%, 200%) rotate(45deg);
            }
            
            #valid-place::after {
                transform: translate(-15%, -50%) rotate(-45deg);
            }
        </style>
    </head>

    <body>
        <div id="drawing">
            <canvas id="image" width="2000" height="2000">Canvas disabled</canvas>
            <canvas id="cursor" width="12000" height="12000">Canvas disabled</canvas>
        </div>
        
        <div id="position">(1000, 1000)</div>

        <div id="timer">
            <svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width="50" height="50" viewBox="0 0 50 50" style=" fill:#1c1b1a;"><path d="M 25 2 C 12.309295 2 2 12.309295 2 25 C 2 37.690705 12.309295 48 25 48 C 37.690705 48 48 37.690705 48 25 C 48 12.309295 37.690705 2 25 2 z M 25 4 C 36.609824 4 46 13.390176 46 25 C 46 36.609824 36.609824 46 25 46 C 13.390176 46 4 36.609824 4 25 C 4 13.390176 13.390176 4 25 4 z M 24.984375 6.9863281 A 1.0001 1.0001 0 0 0 24 8 L 24 22.173828 A 3 3 0 0 0 22 25 A 3 3 0 0 0 22.294922 26.291016 L 16.292969 32.292969 A 1.0001 1.0001 0 1 0 17.707031 33.707031 L 23.708984 27.705078 A 3 3 0 0 0 25 28 A 3 3 0 0 0 28 25 A 3 3 0 0 0 26 22.175781 L 26 8 A 1.0001 1.0001 0 0 0 24.984375 6.9863281 z"></path></svg>
            <div id="time">00:05:00</div>
            <div id="place-mode">Place a tile</div>
        </div>

        <div id="zoom">
            <svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width="30" height="30" viewBox="0 0 30 30" style=" fill:#1c1b1a;"><path d="M 13 3 C 7.4889971 3 3 7.4889971 3 13 C 3 18.511003 7.4889971 23 13 23 C 15.396508 23 17.597385 22.148986 19.322266 20.736328 L 25.292969 26.707031 A 1.0001 1.0001 0 1 0 26.707031 25.292969 L 20.736328 19.322266 C 22.148986 17.597385 23 15.396508 23 13 C 23 7.4889971 18.511003 3 13 3 z M 13 5 C 17.430123 5 21 8.5698774 21 13 C 21 17.430123 17.430123 21 13 21 C 8.5698774 21 5 17.430123 5 13 C 5 8.5698774 8.5698774 5 13 5 z"></path></svg>
            <div id="zoom-level">1x</div>
        </div>

        <div id="place-bar">
            <div id="colors">
                <div id="burgandy" class="color"></div>
                <div id="dark-red" class="color"></div>
                <div id="red" class="color"></div>
                <div id="orange" class="color"></div>
                <div id="yellow" class="color"></div>
                <div id="pale-yellow" class="color"></div>
                <div id="dark-green" class="color"></div>
                <div id="green" class="color"></div>
                <div id="light-green" class="color"></div>
                <div id="dark-teal" class="color"></div>
                <div id="teal" class="color"></div>
                <div id="light-teal" class="color"></div>
                <div id="dark-blue" class="color"></div>
                <div id="blue" class="color"></div>
                <div id="light-blue" class="color"></div>
                <div id="indigo" class="color"></div>
                <div id="periwinkle" class="color"></div>
                <div id="lavender" class="color"></div>
                <div id="dark-purple" class="color"></div>
                <div id="purple" class="color"></div>
                <div id="pale-purple" class="color"></div>
                <div id="magenta" class="color"></div>
                <div id="pink" class="color"></div>
                <div id="light-pink" class="color"></div>
                <div id="dark-brown" class="color"></div>
                <div id="brown" class="color"></div>
                <div id="beige" class="color"></div>
                <div id="black" class="color"></div>
                <div id="dark-gray" class="color"></div>
                <div id="gray" class="color"></div>
                <div id="light-gray" class="color"></div>
                <div id="white" class="color"></div>
            </div>

            <div id="place-button-container">
                <div id="cancel-place"></div>
                <div id="valid-place"></div>
            </div>
        </div>

        <script type="application/javascript">
            const drawing_element = document.getElementById("drawing")
            const image_canvas_element = document.getElementsByTagName("canvas")[0]
            const cursor_canvas_element = document.getElementsByTagName("canvas")[1]
            const position_element = document.getElementById("position")
            const zoom_level_element = document.getElementById("zoom-level")
            const timer_element = document.getElementById("timer")
            const time_element = document.getElementById("time")
            const image_canvas_context = image_canvas_element.getContext('2d')
            const cursor_canvas_context = cursor_canvas_element.getContext('2d')
            let zoom_level = 1;
            const zoom_levels = [1, 2.5, 5, 7.5, 10, 15, 20, 30, 40, 60]
            const canvas_half_heigth = image_canvas_element.clientHeight / 2
            const canvas_offset = { x: canvas_half_heigth, y: canvas_half_heigth }
            const last_position = { x: 1000, y: 1000 }
            const last_screen_position = { x: 0, y: 0 }
            let timer = 300;
            
            image_canvas_context.imageSmoothingEnabled = false

            const clamp = (min, x, max) => Math.max(Math.min(x, max), min)
            const change_pixel = (x, y, color) => {
                image_canvas_context.fillStyle = color
                image_canvas_context.fillRect(x, y, 1, 1)
            }

            // timer
            const complete_number = n => (n.toString().length % 2 ? "0" : "") + n
            const display_time = () => time_element.textContent = `${complete_number(Math.floor(timer / 3600))}:${complete_number(Math.floor(timer / 60 % 60))}:${complete_number(timer % 60)}`
            const reset_timer = () => {
                timer = 300

                timer_element.classList.toggle("place-mode", false)
            }

            setInterval(() => {
                display_time()

                if (timer > 0) timer--
                else timer_element.classList.toggle("place-mode", true)
            }, 1000)

            // zoom
            const change_cursor = (x, y) => {
                cursor_canvas_context.clearRect(0, 0, 12000, 12000)
                cursor_canvas_context.fillStyle = "#9c9894"
                cursor_canvas_context.fillRect(x * 6 - 2, y * 6 - 2, 10, 10)
                cursor_canvas_context.fillStyle = "#5c5956"
                cursor_canvas_context.fillRect(x * 6 - 1, y * 6 - 1, 8, 8)
                cursor_canvas_context.clearRect(x * 6, y * 6, 6, 6)
                cursor_canvas_context.clearRect(x * 6 - 2, y * 6 + 2, 10, 2)
                cursor_canvas_context.clearRect(x * 6 + 2, y * 6 - 2, 2, 10)
            }
            const update_position = () => {
                const canvas_height = image_canvas_element.clientHeight * zoom_levels[zoom_level - 1]

                canvas_offset.x = clamp(0, (1999 - last_position.x) / 2000 * canvas_height, canvas_height * 0.9995)
                canvas_offset.y = clamp(0, (1999 - last_position.y) / 2000 * canvas_height, canvas_height * 0.9995)
                
                drawing_element.style.transform = `translate(${canvas_offset.x - canvas_height}px, ${canvas_offset.y - canvas_height}px)`
                
                change_cursor(last_position.x, last_position.y)
            }

            window.addEventListener("wheel", e => {
                zoom_level -= Math.sign(e.deltaY)
                zoom_level = clamp(1, zoom_level, 10)
                
                zoom_level_element.textContent = zoom_level + "x"
                image_canvas_element.style.transform = `scale(${zoom_levels[zoom_level - 1]})`
                cursor_canvas_element.style.transform = `scale(${zoom_levels[zoom_level - 1]})`

                update_position()
            })

            // change position
            const start = e => {
                e.preventDefault()

                if (e.changedTouches) e = e.changedTouches[0]

                last_screen_position.x = e.screenX
                last_screen_position.y = e.screenY

                window.addEventListener('mousemove', move)
                window.addEventListener('touchmove', move, { passive: false })
                window.addEventListener('mouseup', end)
                window.addEventListener('mouseleave', end)
                window.addEventListener('touchend', end)
                window.addEventListener('touchcancel', end)
                window.addEventListener('touchleave', end)
            }
            const move = e => {
                e.preventDefault()

                if (e.changedTouches) e = e.changedTouches[0]
                
                canvas_offset.x += (e.screenX - last_screen_position.x)
                canvas_offset.y += (e.screenY - last_screen_position.y)

                last_screen_position.x = e.screenX
                last_screen_position.y = e.screenY
                
                requestAnimationFrame(() => {
                    const canvas_height = image_canvas_element.clientHeight * zoom_levels[zoom_level - 1]

                    canvas_offset.x = clamp(0, canvas_offset.x, canvas_height * 0.9995)
                    canvas_offset.y = clamp(0, canvas_offset.y, canvas_height * 0.9995)

                    last_position.x = Math.round(1999 - (canvas_offset.x / canvas_height * 2000))
                    last_position.y = Math.round(1999 - (canvas_offset.y / canvas_height * 2000))

                    position_element.textContent = `(${last_position.x}, ${last_position.y})`

                    drawing_element.style.transform = `translate(${canvas_offset.x - canvas_height}px, ${canvas_offset.y - canvas_height}px)`

                    change_cursor(last_position.x, last_position.y)
                })
            }
            const end = e => {
                e.preventDefault()

                window.removeEventListener('mousemove', move)
                window.removeEventListener('touchmove', move)
                window.removeEventListener('mouseup', end)
                window.removeEventListener('mouseleave', end)
                window.removeEventListener('touchend', end)
                window.removeEventListener('touchcancel', end)
                window.removeEventListener('touchleave', end)
            }

            window.addEventListener("resize", update_position)
            window.addEventListener("mousedown", start)
            window.addEventListener("touchstart", start, { passive: true })

            change_cursor(1000, 1000)
            
            const ws = new WebSocket("ws://replace.tk")
            let last_update = null

            ws.addEventListener("open", () => {
                ws.addEventListener("message", e => {
                    if (typeof e.data === "string") {
                        const split_data = e.data.split("::")
                        const command = split_data.shift()

                        switch (command) {
                            case "register":
                                localStorage.setItem("uuid", split_data.shift())

                                // setup the timer
                                timer = 300 - (new Date() - (last_update = new Date(split_data)))

                                if (timer < 1)  timer_element.classList.toggle("place-mode", true)

                                break
                        }
                    }
                })

                ws.send("register::" + (localStorage.getItem("uuid") || ""))
            })
        </script>
    </body>
</html>